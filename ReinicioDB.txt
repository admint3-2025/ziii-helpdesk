-- ============================================================================
-- LIMPIEZA COMPLETA DE DATOS DE DEMOSTRACIÓN
-- Preserva: usuarios, categorías, activos (assets), sedes (locations), estructura de BD
-- Elimina: tickets, comentarios, historial, auditoría, notificaciones, adjuntos
-- ============================================================================

-- 1. Desactivar temporalmente RLS para limpieza
SET session_replication_role = replica;

-- 2. Eliminar datos de tickets y relacionados
DELETE FROM ticket_comments;
DELETE FROM ticket_status_history;
DELETE FROM tickets;

-- 3. PRESERVAR assets (NO eliminar)
-- Los activos se mantienen intactos

-- 4. Eliminar adjuntos y limpiar bucket de storage
DELETE FROM ticket_attachments;
DELETE FROM storage.objects WHERE bucket_id = 'ticket-attachments';

-- 5. Eliminar notificaciones (si existe)
DO $$ 
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'notifications') THEN
        DELETE FROM notifications;
    END IF;
END $$;

-- 6. Eliminar auditoría
DELETE FROM audit_log;

-- 7. Reiniciar secuencia de ticket_number
ALTER SEQUENCE ticket_number_seq RESTART WITH 1;

-- 8. Reactivar RLS
SET session_replication_role = DEFAULT;

-- 9. Verificar limpieza
SELECT 
  'tickets' as tabla, COUNT(*) as registros FROM tickets
UNION ALL SELECT 'comments', COUNT(*) FROM ticket_comments
UNION ALL SELECT 'historial', COUNT(*) FROM ticket_status_history
UNION ALL SELECT 'adjuntos', COUNT(*) FROM ticket_attachments
UNION ALL SELECT 'archivos_storage', COUNT(*) FROM storage.objects WHERE bucket_id = 'ticket-attachments'
UNION ALL SELECT 'audit_log', COUNT(*) FROM audit_log
UNION ALL SELECT 'usuarios', COUNT(*) FROM profiles
UNION ALL SELECT 'categorías', COUNT(*) FROM categories
UNION ALL SELECT 'activos', COUNT(*) FROM assets
UNION ALL SELECT 'sedes', COUNT(*) FROM locations;

-- Resultado esperado: 0 en tickets/comments/historial/adjuntos/archivos/audit, >0 en usuarios/categorías/activos/sedes